{% extends "base.html" %}

{% block page_subtitle %}
<p>Редактирование ролевой модели и настройка профилей</p>
{% endblock %}

{% block content %}
<div class="edit-form">
    <!-- Основная информация -->
    <div class="form-section" onclick="selectElement(this)">
        <div class="section-title">
            <i class="fas fa-info-circle"></i>
            Основная информация
        </div>
        
        <div class="form-group">
            <label class="form-label">Название ролевой модели</label>
            <input type="text" class="form-input" value="{{ role_model.name }}" placeholder="Введите название" id="roleModelName">
        </div>
        
        <div class="form-group">
            <label class="form-label">Описание</label>
            <textarea class="form-input form-textarea" placeholder="Описание ролевой модели" id="roleModelDescription">{{ role_model.description or "" }}</textarea>
        </div>

        <!-- ИИ-инструменты для модели -->
        <div class="ai-tools-trigger" onclick="toggleAITools('model')" onmouseenter="openAIToolsOnHover('model')">
            <i class="fas fa-magic"></i>
        </div>
        <div class="ai-tools-menu" id="model-tools">
            <div class="ai-tools-menu-item" onclick="aiOptimizeModel()">
                <i class="fas fa-magic"></i>
                Оптимизировать
            </div>
            <div class="ai-tools-menu-item" onclick="aiAnalyzeGaps()">
                <i class="fas fa-search"></i>
                Найти пробелы
            </div>
            <div class="ai-tools-menu-item" onclick="aiSuggestProfiles()">
                <i class="fas fa-lightbulb"></i>
                Предложить
            </div>
            <div class="ai-tools-menu-item" onclick="aiCompareModels()">
                <i class="fas fa-balance-scale"></i>
                Сравнить
            </div>
            <div class="ai-tools-menu-item" onclick="aiValidateCriteria()">
                <i class="fas fa-check-circle"></i>
                Проверить
            </div>
            <div class="ai-tools-menu-item" onclick="aiGenerateReport()">
                <i class="fas fa-chart-bar"></i>
                Отчет
            </div>
        </div>
    </div>

    <!-- Профили ролей -->
    <div class="form-section" onclick="selectElement(this)">
        <div class="section-title">
            <i class="fas fa-users"></i>
            Профили ролей
        </div>
        
        <div class="profiles-list">
            {% for profile in profiles %}
            <div class="profile-item" data-profile="{{ profile.id }}" onclick="selectElement(this)">
                <div class="profile-info">
                    <div class="profile-name">{{ profile.name }}</div>
                    <div class="profile-criteria">
                        {% if profile.criteria %}
                            {% set criteria_parts = [] %}
                            {% if profile.criteria.get('employee_profiles') %}
                                {% set _ = criteria_parts.append(profile.criteria.employee_profiles|join(', ')) %}
                            {% endif %}
                            {% if profile.criteria.get('positions') %}
                                {% set _ = criteria_parts.append(profile.criteria.positions|join(', ')) %}
                            {% endif %}
                            {% if profile.criteria.get('org_units_type') %}
                                {% set _ = criteria_parts.append(profile.criteria.org_units_type|join(', ')) %}
                            {% endif %}
                            {{ criteria_parts|join(' • ') }}
                        {% else %}
                            Критерии не заданы
                        {% endif %}
                    </div>
                </div>
                <div class="profile-actions">
                    <button class="btn btn-primary btn-sm" onclick="event.stopPropagation(); editProfile({{ profile.id }})">
                        <i class="fas fa-edit"></i> Редактировать
                    </button>
                    <button class="btn btn-secondary btn-sm" onclick="event.stopPropagation(); duplicateProfile({{ profile.id }})">
                        <i class="fas fa-copy"></i> Дублировать
                    </button>
                    <button class="btn btn-secondary btn-sm" onclick="event.stopPropagation(); deleteProfile({{ profile.id }})">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
                
                <!-- ИИ-инструменты для профиля -->
                <div class="ai-tools-trigger" onclick="toggleAITools('profile-{{ profile.id }}')" onmouseenter="openAIToolsOnHover('profile-{{ profile.id }}')">
                    <i class="fas fa-magic"></i>
                </div>
                <div class="ai-tools-menu" id="profile-{{ profile.id }}-tools">
                    <div class="ai-tools-menu-item" onclick="aiOptimizeCriteria({{ profile.id }})">
                        <i class="fas fa-tune"></i>
                        Оптимизировать
                    </div>
                    <div class="ai-tools-menu-item" onclick="aiSuggestAccesses({{ profile.id }})">
                        <i class="fas fa-key"></i>
                        Доступы
                    </div>
                    <div class="ai-tools-menu-item" onclick="aiSplitProfile({{ profile.id }})">
                        <i class="fas fa-expand-arrows-alt"></i>
                        Разделить
                    </div>
                    <div class="ai-tools-menu-item" onclick="aiAutoComplete({{ profile.id }})">
                        <i class="fas fa-magic"></i>
                        Автодополнение
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        
        <button class="btn btn-primary" onclick="addNewProfile()" style="margin-top: 15px;">
            <i class="fas fa-plus"></i> Добавить профиль
        </button>
    </div>
</div>

<div class="form-actions">
    <button class="btn btn-secondary" onclick="window.location.href='/role-models/{{ role_model.id }}'">
        <i class="fas fa-times"></i> Отмена
    </button>
    <button class="btn btn-primary" onclick="saveModel()">
        <i class="fas fa-save"></i> Сохранить изменения
    </button>
</div>
{% endblock %}

{% block chat_context %}Редактирование: {{ role_model.name }}{% endblock %}

{% block chat_placeholder %}Задай вопрос о редактировании...{% endblock %}

{% block extra_js %}
<script>
    let currentContext = null;

    function selectElement(element) {
        // Убираем выделение с других элементов
        document.querySelectorAll('.selected').forEach(el => {
            el.classList.remove('selected');
        });
        
        // Выделяем текущий элемент
        element.classList.add('selected');
    }

    function toggleAITools(toolId) {
        // Закрываем все открытые меню
        document.querySelectorAll('.ai-tools-menu.active').forEach(menu => {
            menu.classList.remove('active');
        });
        
        // Открываем нужное меню
        const menu = document.getElementById(toolId + '-tools');
        if (menu) {
            menu.classList.add('active');
            
            // Проверяем, не выходит ли меню за границы экрана
            const rect = menu.getBoundingClientRect();
            const viewportHeight = window.innerHeight;
            
            // Если меню выходит за нижнюю границу, переворачиваем его
            if (rect.bottom > viewportHeight - 20) {
                menu.classList.add('overlap');
            } else {
                menu.classList.remove('overlap');
            }
        }
    }

    function openAIToolsOnHover(toolId) {
        // Открываем меню при наведении
        const menu = document.getElementById(toolId + '-tools');
        if (menu && !menu.classList.contains('active')) {
            menu.classList.add('active');
            
            // Проверяем позиционирование
            const rect = menu.getBoundingClientRect();
            const viewportHeight = window.innerHeight;
            
            if (rect.bottom > viewportHeight - 20) {
                menu.classList.add('overlap');
            } else {
                menu.classList.remove('overlap');
            }
        }
    }

    // Обработка кликов на элементы
    document.addEventListener('click', function(e) {
        // Если кликнули на кнопку или input - не обрабатываем
        if (e.target.closest('button') || e.target.closest('input') || e.target.closest('textarea')) {
            return;
        }
        
        // Если кликнули на триггер ИИ-инструментов
        if (e.target.closest('.ai-tools-trigger')) {
            return; // Не снимаем выделение и не закрываем меню
        }
        
        // Если кликнули на элемент с ИИ-инструментами
        if (e.target.closest('.form-section') || e.target.closest('.profile-item')) {
            const element = e.target.closest('.form-section') || e.target.closest('.profile-item');
            selectElement(element);
            return;
        }
    });

    // Закрытие меню при потере фокуса
    document.addEventListener('focusout', function(e) {
        setTimeout(() => {
            if (!document.activeElement || !document.activeElement.closest('.ai-tools-menu')) {
                document.querySelectorAll('.ai-tools-menu.active').forEach(menu => {
                    menu.classList.remove('active');
                });
            }
        }, 100);
    });

    // Закрытие меню при уводе мыши за пределы панели
    document.addEventListener('mouseleave', function(e) {
        if (e.target.closest('.ai-tools-menu')) {
            setTimeout(() => {
                const hoveredElement = document.elementFromPoint(e.clientX, e.clientY);
                if (!hoveredElement || !hoveredElement.closest('.ai-tools-menu')) {
                    document.querySelectorAll('.ai-tools-menu.active').forEach(menu => {
                        menu.classList.remove('active');
                    });
                }
            }, 200);
        }
    });

    // Дополнительная проверка при движении мыши
    document.addEventListener('mousemove', function(e) {
        if (!e.target.closest('.ai-tools-menu') && !e.target.closest('.ai-tools-trigger')) {
            const activeMenus = document.querySelectorAll('.ai-tools-menu.active');
            if (activeMenus.length > 0) {
                let shouldClose = true;
                activeMenus.forEach(menu => {
                    const rect = menu.getBoundingClientRect();
                    const distance = Math.sqrt(
                        Math.pow(e.clientX - (rect.left + rect.width/2), 2) + 
                        Math.pow(e.clientY - (rect.top + rect.height/2), 2)
                    );
                    
                    const triggerId = menu.id.replace('-tools', '');
                    const trigger = document.querySelector(`[onclick*="${triggerId}"]`);
                    let triggerDistance = Infinity;
                    if (trigger) {
                        const triggerRect = trigger.getBoundingClientRect();
                        triggerDistance = Math.sqrt(
                            Math.pow(e.clientX - (triggerRect.left + triggerRect.width/2), 2) + 
                            Math.pow(e.clientY - (triggerRect.top + triggerRect.height/2), 2)
                        );
                    }
                    
                    if (distance < 120 || triggerDistance < 50) {
                        shouldClose = false;
                    }
                });
                
                if (shouldClose) {
                    activeMenus.forEach(menu => {
                        menu.classList.remove('active');
                    });
                }
            }
        }
    });

    // ИИ-инструменты для ролевой модели
    async function aiOptimizeModel() {
        await callAITool('role-model/{{ role_model.id }}/optimize', { type: 'role_model', id: {{ role_model.id }} });
    }

    async function aiAnalyzeGaps() {
        await callAITool('role-model/{{ role_model.id }}/analyze-gaps', { type: 'role_model', id: {{ role_model.id }} });
    }

    async function aiSuggestProfiles() {
        addAIMessage('💡 Анализируя данные сотрудников, предлагаю добавить профили: 1) "Senior Java Developer" (опыт 5+ лет), 2) "React Developer" (отдельно от общего Frontend), 3) "DevOps Engineer" (Docker, Kubernetes). Создать эти профили?');
    }

    async function aiCompareModels() {
        addAIMessage('⚖️ Сравниваю с другими ролевыми моделями в системе... Нашел похожие модели: "IT Support" и "Data Engineer". Можем заимствовать лучшие практики или объединить пересекающиеся профили. Показать детали?');
    }

    async function aiValidateCriteria() {
        addAIMessage('✅ Проверяю критерии профилей... Найдены проблемы: 1) В Java Backend слишком широкие критерии (попадают 45% сотрудников), 2) В Frontend нет критерия по опыту с TypeScript. Исправить эти критерии?');
    }

    async function aiGenerateReport() {
        addAIMessage('📊 Создаю отчет по ролевой модели... Готов отчет: {{ profiles|length }} профилей, покрывают 0 сотрудников. Основные рекомендации: добавить Senior профили, уточнить критерии. Открыть полный отчет?');
    }

    // ИИ-инструменты для профилей
    async function aiOptimizeCriteria(profileId) {
        await callAITool(`profile/${profileId}/optimize-criteria`, { type: 'profile', id: profileId });
    }

    async function aiSuggestAccesses(profileId) {
        await callAITool(`profile/${profileId}/suggest-accesses`, { type: 'profile', id: profileId });
    }

    async function aiSplitProfile(profileId) {
        await callAITool(`profile/${profileId}/split`, { type: 'profile', id: profileId });
    }

    async function aiAutoComplete(profileId) {
        addAIMessage(`✨ Автодополняю недостающие данные для профиля ${profileId}... Добавил: критерий "участие в code review", доступ к "системе управления задачами". Сохранить изменения?`);
    }

    // Обычные функции редактирования
    function editProfile(profileId) {
        // TODO: Реализовать редактирование профиля
        alert(`Редактировать профиль ${profileId} - TODO`);
    }

    function duplicateProfile(profileId) {
        // TODO: Реализовать дублирование профиля
        alert(`Дублировать профиль ${profileId} - TODO`);
    }

    function deleteProfile(profileId) {
        if (confirm('Удалить профиль?')) {
            // TODO: Реализовать удаление профиля
            alert(`Профиль ${profileId} удален - TODO`);
        }
    }

    function addNewProfile() {
        // TODO: Реализовать добавление нового профиля
        alert('Добавить новый профиль - TODO');
    }

    async function saveModel() {
        try {
            const name = document.getElementById('roleModelName').value;
            const description = document.getElementById('roleModelDescription').value;
            
            // TODO: Реальная отправка данных на сервер
            const response = await fetch(`/api/v1/role-models/{{ role_model.id }}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    name: name,
                    description: description
                })
            });
            
            if (response.ok) {
                addAIMessage('✅ Ролевая модель успешно сохранена!');
                setTimeout(() => {
                    window.location.href = '/role-models/{{ role_model.id }}';
                }, 1000);
            } else {
                addAIMessage('❌ Ошибка сохранения ролевой модели');
            }
        } catch (error) {
            console.error('Ошибка сохранения:', error);
            addAIMessage('❌ Произошла ошибка при сохранении');
        }
    }
</script>
{% endblock %}
