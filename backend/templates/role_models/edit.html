{% extends "base.html" %}

{% block extra_css %}
<style>
    .edit-form {
        background: white;
        border-radius: 15px;
        padding: 30px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        margin-bottom: 30px;
        border: 1px solid #e9ecef;
    }

    .form-section {
        margin-bottom: 25px;
        padding: 20px;
        border: 2px solid transparent;
        border-radius: 10px;
        transition: all 0.3s ease;
        cursor: pointer;
        position: relative;
    }

    .form-section:hover {
        border-color: #17a2b8;
        background: #f8f9fa;
    }

    .form-section.focused {
        border-color: #17a2b8;
        background: #f8f9fa;
        box-shadow: 0 0 0 3px rgba(23, 162, 184, 0.1);
    }

    .section-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: #495057;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-label {
        display: flex;
        align-items: center;
        font-weight: 500;
        color: #495057;
        margin-bottom: 8px;
        font-size: 0.9rem;
    }

    .form-input, .form-textarea {
        width: 100%;
        padding: 12px 15px;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        font-size: 0.95rem;
        transition: border-color 0.3s ease;
        background: white;
    }

    .form-input:focus, .form-textarea:focus {
        outline: none;
        border-color: #17a2b8;
        box-shadow: 0 0 0 3px rgba(23, 162, 184, 0.1);
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(23, 162, 184, 0.15);
    }

    .form-textarea {
        resize: vertical;
        min-height: 100px;
    }

    .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        font-size: 0.9rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        text-decoration: none;
    }

    .btn-primary {
        background: #17a2b8;
        color: white;
    }

    .btn-primary:hover {
        background: #138496;
        transform: translateY(-1px);
    }

    .btn-secondary {
        background: #6c757d;
        color: white;
    }

    .btn-secondary:hover {
        background: #5a6268;
    }

    .btn-success {
        background: #28a745;
        color: white;
    }

    .btn-success:hover {
        background: #218838;
    }

    .btn-danger {
        background: #dc3545;
        color: white;
    }

    .btn-danger:hover {
        background: #c82333;
    }

    .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        padding: 20px 0;
        border-bottom: 2px solid #e9ecef;
    }

    .header h1 {
        margin: 0;
        color: #495057;
        font-size: 1.8rem;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .header-actions {
        display: flex;
        gap: 10px;
    }

    .badge {
        background: #17a2b8;
        color: white;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: 500;
    }

    .form-actions {
        display: flex;
        gap: 15px;
        justify-content: flex-end;
        margin-top: 30px;
        padding-top: 20px;
        border-top: 1px solid #e9ecef;
    }

    .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }

    /* Стили для профилей */
    .profiles-list {
        border: 1px solid #e9ecef;
        border-radius: 8px;
        overflow: hidden;
    }

    .profile-item {
        padding: 15px 20px;
        border-bottom: 1px solid #f1f3f4;
        display: flex;
        align-items: center;
        justify-content: space-between;
        transition: all 0.3s ease;
        position: relative;
    }

    .profile-item.selected .ai-tools-trigger,
    .profile-item:hover .ai-tools-trigger {
        opacity: 1;
        transform: scale(1);
    }

    .profile-item:last-child {
        border-bottom: none;
    }

    .profile-item:hover {
        background: #f8f9ff;
    }

    .profile-info {
        flex: 1;
    }

    .profile-name {
        font-weight: 500;
        color: #333;
        margin-bottom: 5px;
    }

    .profile-criteria {
        font-size: 0.85rem;
        color: #666;
    }

    .profile-actions {
        display: flex;
        gap: 8px;
    }

    .btn-sm {
        padding: 6px 12px;
        font-size: 0.8rem;
    }

    /* Стили для AI помощника */
    .ai-assistant-btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        font-size: 0.8rem;
        cursor: pointer;
        margin-left: 8px;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }

    .ai-assistant-btn:hover {
        transform: scale(1.1);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }

    /* ИИ-инструменты */
    .ai-tools-trigger {
        position: absolute;
        bottom: 8px;
        left: 8px;
        width: 28px;
        height: 28px;
        background: rgba(23, 162, 184, 0.8);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 0.8rem;
        cursor: pointer;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        transition: all 0.3s ease;
        opacity: 0;
        transform: scale(0.8);
        z-index: 10;
    }

    .ai-tools-trigger:hover {
        background: rgba(23, 162, 184, 1);
        transform: scale(1.1);
    }

    .ai-tools-trigger.visible {
        opacity: 1;
        transform: scale(1);
    }

    .ai-tools-menu {
        position: absolute;
        bottom: 0;
        left: 0;
        background: white;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        border: 1px solid #e9ecef;
        padding: 8px;
        opacity: 0;
        transform: translateY(10px);
        transition: all 0.3s ease;
        pointer-events: none;
        z-index: 1000;
        display: flex;
        gap: 6px;
        white-space: nowrap;
    }

    .ai-tools-menu.active {
        opacity: 1;
        transform: translateY(0);
        pointer-events: all;
    }

    .ai-tools-menu.overlap {
        bottom: auto;
        top: 0;
        transform: translateY(-10px);
    }

    .ai-tools-menu.overlap.active {
        transform: translateY(0);
    }

    .ai-tools-menu-item {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 8px 12px;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 0.8rem;
        color: #495057;
        white-space: nowrap;
    }

    .ai-tools-menu-item:hover {
        background: #17a2b8;
        color: white;
        border-color: #17a2b8;
    }

    .ai-tools-menu-item i {
        color: inherit;
        font-size: 0.9rem;
    }

    /* Анимации */
    .form-section {
        animation: fadeInUp 0.3s ease-out;
    }

    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>
{% endblock %}

{% block page_subtitle %}
<p>Редактирование ролевой модели и настройка профилей</p>
{% endblock %}

{% block content %}
<div class="container">
    
    <div class="header">
        <h1><i class="fas fa-user-tie"></i> Редактирование ролевой модели</h1>
        <div class="header-actions">
            <a href="/role-models" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Назад к списку
            </a>
        </div>
    </div>

    <div class="edit-form">
        <form id="editForm">
            <!-- Основная информация -->
            <div class="form-section" onclick="focusSection(this)">
                <div class="section-title">
                    <i class="fas fa-info-circle"></i>
                    Основная информация
                </div>
                
                <div class="form-group">
                    <label class="form-label">Название ролевой модели</label>
                    <input type="text" class="form-input" id="modelName" value="{{ role_model.name }}" placeholder="Введите название ролевой модели">
                </div>
                
                <div class="form-group">
                    <label class="form-label">
                        Описание
                        <button type="button" class="ai-assistant-btn" onclick="aiHelpDescription()" title="AI помощник для описания">
                            <i class="fas fa-magic"></i>
                        </button>
                    </label>
                    <textarea class="form-textarea" id="modelDescription" placeholder="Опишите назначение и особенности ролевой модели">{{ role_model.description }}</textarea>
                </div>
            </div>

            <!-- Профили доступа -->
            <div class="form-section" onclick="focusSection(this)">
                <div class="section-title">
                    <i class="fas fa-shield-alt"></i>
                    Профили доступа
                    <span class="badge">{{ profiles|length }}</span>
                </div>
                
                <div id="profilesContainer">
                    {% for profile in profiles %}
                    <div class="profile-item" data-profile="{{ profile.id }}" onclick="selectElement(this)">
                        <div class="profile-info">
                            <div class="profile-name">{{ profile.name }}</div>
                            <div class="profile-criteria">{{ profile.description }}</div>
                        </div>
                        <div class="profile-actions">
                            <button class="btn btn-primary btn-sm" onclick="editProfile('{{ profile.id }}')">
                                <i class="fas fa-edit"></i> Редактировать
                            </button>
                            <button class="btn btn-secondary btn-sm" onclick="duplicateProfile('{{ profile.id }}')">
                                <i class="fas fa-copy"></i> Дублировать
                            </button>
                            <button class="btn btn-secondary btn-sm" onclick="deleteProfile('{{ profile.id }}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                        
                        <!-- ИИ-инструменты для профиля -->
                        <div class="ai-tools-trigger" onclick="toggleAITools('{{ profile.id }}')" onmouseenter="openAIToolsOnHover('{{ profile.id }}')">
                            <i class="fas fa-magic"></i>
                        </div>
                        <div class="ai-tools-menu" id="{{ profile.id }}-tools">
                            <div class="ai-tools-menu-item" onclick="aiOptimizeCriteria('{{ profile.id }}')">
                                <i class="fas fa-tune"></i>
                                Оптимизировать
                            </div>
                            <div class="ai-tools-menu-item" onclick="aiSuggestAccesses('{{ profile.id }}')">
                                <i class="fas fa-key"></i>
                                Доступы
                            </div>
                            <div class="ai-tools-menu-item" onclick="aiSplitProfile('{{ profile.id }}')">
                                <i class="fas fa-expand-arrows-alt"></i>
                                Разделить
                            </div>
                            <div class="ai-tools-menu-item" onclick="aiAutoComplete('{{ profile.id }}')">
                                <i class="fas fa-magic"></i>
                                Автодополнение
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                
                <button type="button" class="btn btn-primary" onclick="addNewProfile()">
                    <i class="fas fa-plus"></i> Добавить профиль
                </button>
            </div>

            <!-- AI инструменты для модели -->
            <div class="ai-tools-trigger" onclick="toggleAITools('model')" onmouseenter="openAIToolsOnHover('model')">
                <i class="fas fa-magic"></i>
            </div>
            <div class="ai-tools-menu" id="model-tools">
                <div class="ai-tools-menu-item" onclick="aiOptimizeModel()">
                    <i class="fas fa-magic"></i>
                    Оптимизировать
                </div>
                <div class="ai-tools-menu-item" onclick="aiAnalyzeGaps()">
                    <i class="fas fa-search"></i>
                    Найти пробелы
                </div>
                <div class="ai-tools-menu-item" onclick="aiSuggestProfiles()">
                    <i class="fas fa-lightbulb"></i>
                    Предложить
                </div>
                <div class="ai-tools-menu-item" onclick="aiCompareModels()">
                    <i class="fas fa-balance-scale"></i>
                    Сравнить
                </div>
                <div class="ai-tools-menu-item" onclick="aiValidateCriteria()">
                    <i class="fas fa-check-circle"></i>
                    Проверить
                </div>
                <div class="ai-tools-menu-item" onclick="aiGenerateReport()">
                    <i class="fas fa-chart-bar"></i>
                    Отчет
                </div>
            </div>

            <!-- Действия -->
            <div class="form-actions">
                <button type="button" class="btn btn-success" onclick="saveModel()">
                    <i class="fas fa-save"></i> Сохранить изменения
                </button>
                <button type="button" class="btn btn-secondary" onclick="window.location.href='/role-models'">
                    <i class="fas fa-times"></i> Отмена
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Центральное меню ИИ-инструментов -->
<div class="ai-tools-center" id="aiToolsCenter">
    <button class="ai-tools-center-btn" onclick="aiMergeProfiles()">
        <i class="fas fa-compress-arrows-alt"></i>
        Объединить
    </button>
    <button class="ai-tools-center-btn" onclick="aiAnalyzeOverlap()">
        <i class="fas fa-project-diagram"></i>
        Анализ
    </button>
    <button class="ai-tools-center-btn" onclick="aiGenerateReport()">
        <i class="fas fa-chart-bar"></i>
        Отчет
    </button>
</div>


<!-- Контекстный чат -->
<div class="context-chat" id="contextChat">
    <div class="chat-header">
        <div class="chat-header-info">
            <div class="chat-avatar">
                <i class="fas fa-robot"></i>
            </div>
            <div>
                <div class="chat-title">ИИ-Ассистент</div>
                <div class="chat-context" id="chatContext">Редактирование ролевой модели</div>
            </div>
        </div>
        <button class="close-chat" onclick="closeContextChat()">
            <i class="fas fa-times"></i>
        </button>
    </div>
    
    <div class="chat-messages" id="chatMessages">
        <div class="chat-message ai">
            <div class="chat-message-avatar">
                <i class="fas fa-robot"></i>
            </div>
            <div class="chat-message-content">
                Привет! Я помогу тебе с редактированием ролевой модели. Используй кнопки ИИ-инструментов или задай вопрос.
            </div>
        </div>
    </div>
    
    <div class="chat-input-area">
        <div class="chat-input-container">
            <textarea class="chat-input" id="chatInput" placeholder="Задай вопрос о редактировании..." rows="1"></textarea>
            <button class="chat-send-btn" onclick="sendMessage()">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>
</div>

<script>

function openContextChat() {
    document.getElementById('contextChat').classList.add('active');
    document.getElementById('chatMinimal').classList.add('hidden');
}

function closeContextChat() {
    document.getElementById('contextChat').classList.remove('active');
    document.getElementById('chatMinimal').classList.remove('hidden');
    document.querySelectorAll('.focused').forEach(el => el.classList.remove('focused'));
    currentContext = null;
}

function sendMessage() {
    const input = document.getElementById('chatInput');
    const message = input.value.trim();
    
    if (!message) return;
    
    addUserMessage(message);
    input.value = '';
    
    setTimeout(() => {
        const response = generateAIResponse(message);
        addAIMessage(response);
    }, 1000);
}

function addUserMessage(message) {
    const messagesContainer = document.getElementById('chatMessages');
    const messageDiv = document.createElement('div');
    messageDiv.className = 'chat-message user';
    messageDiv.innerHTML = `
        <div class="chat-message-avatar">
            <i class="fas fa-user"></i>
        </div>
        <div class="chat-message-content">${message}</div>
    `;
    messagesContainer.appendChild(messageDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function addAIMessage(message) {
    const messagesContainer = document.getElementById('chatMessages');
    const messageDiv = document.createElement('div');
    messageDiv.className = 'chat-message ai';
    messageDiv.innerHTML = `
        <div class="chat-message-avatar">
            <i class="fas fa-robot"></i>
        </div>
        <div class="chat-message-content">${message}</div>
    `;
    messagesContainer.appendChild(messageDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function generateAIResponse(userMessage) {
    const responses = [
        'Понял твой вопрос. Могу помочь с оптимизацией ролевой модели, анализом профилей или предложить улучшения.',
        'Хочешь использовать один из ИИ-инструментов? Они помогут автоматизировать многие задачи редактирования.',
        'Могу предложить оптимальные критерии для профилей, найти пересечения или создать новые профили на основе данных.',
        'Используй кнопки ИИ-инструментов для быстрого выполнения сложных операций с ролевой моделью.'
    ];
    
    return responses[Math.floor(Math.random() * responses.length)];
}

function selectElement(element) {
    // Убираем выделение с других элементов
    document.querySelectorAll('.selected').forEach(el => {
        el.classList.remove('selected');
    });
    
    // Выделяем текущий элемент
    element.classList.add('selected');
}

function toggleAITools(toolId) {
    // Закрываем все открытые меню
    document.querySelectorAll('.ai-tools-menu.active').forEach(menu => {
        menu.classList.remove('active');
    });
    
    // Открываем нужное меню
    const menu = document.getElementById(toolId + '-tools');
    if (menu) {
        menu.classList.add('active');
        
        // Проверяем, не выходит ли меню за границы экрана
        const rect = menu.getBoundingClientRect();
        const viewportHeight = window.innerHeight;
        
        // Если меню выходит за нижнюю границу, переворачиваем его
        if (rect.bottom > viewportHeight - 20) {
            menu.classList.add('overlap');
        } else {
            menu.classList.remove('overlap');
        }
    }
}

function openAIToolsOnHover(toolId) {
    // Открываем меню при наведении
    const menu = document.getElementById(toolId + '-tools');
    if (menu && !menu.classList.contains('active')) {
        menu.classList.add('active');
        
        // Проверяем позиционирование
        const rect = menu.getBoundingClientRect();
        const viewportHeight = window.innerHeight;
        
        if (rect.bottom > viewportHeight - 20) {
            menu.classList.add('overlap');
        } else {
            menu.classList.remove('overlap');
        }
    }
}

// ИИ-инструменты для ролевой модели
function aiOptimizeModel() {
    addAIMessage('🔧 Анализирую ролевую модель... Нашел несколько возможностей для оптимизации: 1) Объединить похожие профили, 2) Уточнить критерии попадания, 3) Добавить недостающие доступы. Хочешь применить эти изменения?');
}

function aiAnalyzeGaps() {
    addAIMessage('🔍 Анализирую пробелы в ролевой модели... Обнаружил: 1) Отсутствует профиль для DevOps инженеров, 2) Нет критериев по стажу для Senior разработчиков, 3) Не хватает доступов к системам мониторинга. Предлагаю добавить эти элементы?');
}

function aiSuggestProfiles() {
    addAIMessage('💡 Анализируя данные сотрудников, предлагаю добавить профили: 1) "Senior Java Developer" (опыт 5+ лет), 2) "React Developer" (отдельно от общего Frontend), 3) "DevOps Engineer" (Docker, Kubernetes). Создать эти профили?');
}

function aiCompareModels() {
    addAIMessage('⚖️ Сравниваю с другими ролевыми моделями в системе... Нашел похожие модели: "IT Support" и "Data Engineer". Можем заимствовать лучшие практики или объединить пересекающиеся профили. Показать детали?');
}

function aiValidateCriteria() {
    addAIMessage('✅ Проверяю критерии профилей... Найдены проблемы: 1) В Java Backend слишком широкие критерии (попадают 45% сотрудников), 2) В Frontend нет критерия по опыту с TypeScript. Исправить эти критерии?');
}

function aiGenerateReport() {
    addAIMessage('📊 Создаю отчет по ролевой модели... Готов отчет: 2 профиля, 15 доступов, покрывают 25 сотрудников (12% от IT-блока). Основные рекомендации: добавить Senior профили, уточнить критерии. Открыть полный отчет?');
}

// ИИ-инструменты для профилей
function aiMergeProfiles() {
    addAIMessage('🔗 Анализирую возможность объединения профилей... Java Backend и Frontend имеют схожие доступы к системам разработки. Могу создать объединенный профиль "Full-Stack Developer" с гибкими критериями. Объединить?');
}

function aiSplitProfile(profileId) {
    const profileName = profileId === 'java-backend' ? 'Java Backend' : 'Frontend';
    addAIMessage(`✂️ Анализирую возможность разделения профиля ${profileName}... Можно разделить на "Junior" (опыт 1-3 года) и "Senior" (опыт 3+ лет) с разными доступами. Разделить профиль?`);
}

function aiOptimizeCriteria(profileId) {
    const profileName = profileId === 'java-backend' ? 'Java Backend' : 'Frontend';
    addAIMessage(`🎯 Оптимизирую критерии профиля ${profileName}... Предлагаю изменения: ${profileId === 'java-backend' ? 'добавить "знание Spring Boot"' : 'уточнить "опыт с современными фреймворками 2+ года"'}. Применить оптимизацию?`);
}

function aiSuggestAccesses(profileId) {
    const profileName = profileId === 'java-backend' ? 'Java Backend' : 'Frontend';
    addAIMessage(`🔑 Анализирую доступы профиля ${profileName}... Предлагаю добавить: ${profileId === 'java-backend' ? 'доступ к SonarQube для анализа кода' : 'доступ к Storybook для компонентов'}. Добавить эти доступы?`);
}

function aiAnalyzeOverlap() {
    addAIMessage('🔀 Анализирую пересечения профилей... Найдены пересечения: 12 сотрудников попадают в оба профиля (Java Backend и Frontend). Это может указывать на Full-Stack разработчиков. Создать отдельный профиль?');
}

function aiAutoComplete(profileId) {
    const profileName = profileId === 'java-backend' ? 'Java Backend' : 'Frontend';
    addAIMessage(`✨ Автодополняю недостающие данные для ${profileName}... Добавил: ${profileId === 'java-backend' ? 'критерий "участие в code review"' : 'доступ к "системе управления задачами"'}. Сохранить изменения?`);
}

// Обычные функции редактирования
function editProfile(profileId) {
    alert(`Редактировать профиль ${profileId}`);
}

function duplicateProfile(profileId) {
    alert(`Дублировать профиль ${profileId}`);
}

function deleteProfile(profileId) {
    if (confirm('Удалить профиль?')) {
        alert(`Профиль ${profileId} удален`);
    }
}

function addNewProfile() {
    alert('Добавить новый профиль');
}

function saveModel() {
    alert('Ролевая модель сохранена');
}

// AI помощник для описания
function aiHelpDescription() {
    const modelName = document.getElementById('modelName').value;
    
    if (!modelName.trim()) {
        alert('Сначала введите название ролевой модели!');
        return;
    }
    
    alert('AI генерирует описание...');
    
    setTimeout(() => {
        const suggestions = [
            `Ролевая модель "${modelName}" предназначена для управления доступом сотрудников к корпоративным системам и ресурсам.`,
            `Модель обеспечивает разграничение прав доступа в соответствии с должностными обязанностями и уровнем ответственности.`,
            `Включает в себя набор профилей доступа, каждый из которых определяет права конкретной группы пользователей.`
        ];
        
        const currentDesc = document.getElementById('modelDescription').value;
        const newDesc = currentDesc ? currentDesc + '\n\n' + suggestions.join(' ') : suggestions.join(' ');
        
        if (confirm('Заменить текущее описание на сгенерированное AI?')) {
            document.getElementById('modelDescription').value = newDesc;
        } else {
            alert(`AI предложения:\n\n${suggestions.join('\n')}`);
        }
    }, 1500);
}

// Обработка кликов на элементы
document.addEventListener('click', function(e) {
    // Проверяем, что e.target существует и имеет метод closest
    if (!e.target || typeof e.target.closest !== 'function') {
        return;
    }
    
    // Если кликнули на кнопку или input - не обрабатываем
    if (e.target.closest('button') || e.target.closest('input') || e.target.closest('textarea')) {
        return;
    }
    
    // Если кликнули на триггер ИИ-инструментов
    if (e.target.closest('.ai-tools-trigger')) {
        return; // Не снимаем выделение и не закрываем меню
    }
    
    // Если кликнули на элемент с ИИ-инструментами
    if (e.target.closest('.form-section') || e.target.closest('.profile-item')) {
        const element = e.target.closest('.form-section') || e.target.closest('.profile-item');
        selectElement(element);
        return;
    }
});

// Закрытие меню при потере фокуса
document.addEventListener('focusout', function(e) {
    // Небольшая задержка, чтобы клик на меню успел сработать
    setTimeout(() => {
        if (!document.activeElement || !document.activeElement.closest('.ai-tools-menu')) {
            document.querySelectorAll('.ai-tools-menu.active').forEach(menu => {
                menu.classList.remove('active');
            });
        }
    }, 100);
});

// Закрытие меню при уводе мыши за пределы панели
document.addEventListener('mouseleave', function(e) {
    // Проверяем, что e.target существует и имеет метод closest
    if (!e.target || typeof e.target.closest !== 'function') {
        return;
    }
    
    // Проверяем, что мышь покинула область меню
    if (e.target.closest('.ai-tools-menu')) {
        setTimeout(() => {
            // Проверяем, что мышь действительно не над меню
            const hoveredElement = document.elementFromPoint(e.clientX, e.clientY);
            if (!hoveredElement || !hoveredElement.closest('.ai-tools-menu')) {
                document.querySelectorAll('.ai-tools-menu.active').forEach(menu => {
                    menu.classList.remove('active');
                });
            }
        }, 200);
    }
});

// Дополнительная проверка при движении мыши
document.addEventListener('mousemove', function(e) {
    // Проверяем, что e.target существует и имеет метод closest
    if (!e.target || typeof e.target.closest !== 'function') {
        return;
    }
    
    // Если мышь не над меню и не над триггером, закрываем меню
    if (!e.target.closest('.ai-tools-menu') && !e.target.closest('.ai-tools-trigger')) {
        const activeMenus = document.querySelectorAll('.ai-tools-menu.active');
        if (activeMenus.length > 0) {
            // Проверяем, что мышь действительно далеко от меню и триггера
            let shouldClose = true;
            activeMenus.forEach(menu => {
                const rect = menu.getBoundingClientRect();
                const distance = Math.sqrt(
                    Math.pow(e.clientX - (rect.left + rect.width/2), 2) + 
                    Math.pow(e.clientY - (rect.top + rect.height/2), 2)
                );
                
                // Проверяем расстояние до соответствующего триггера
                const triggerId = menu.id.replace('-tools', '');
                const trigger = document.querySelector(`[onclick*="${triggerId}"]`);
                let triggerDistance = Infinity;
                if (trigger) {
                    const triggerRect = trigger.getBoundingClientRect();
                    triggerDistance = Math.sqrt(
                        Math.pow(e.clientX - (triggerRect.left + triggerRect.width/2), 2) + 
                        Math.pow(e.clientY - (triggerRect.top + triggerRect.height/2), 2)
                    );
                }
                
                if (distance < 120 || triggerDistance < 50) { // Если мышь близко к меню или триггеру
                    shouldClose = false;
                }
            });
            
            if (shouldClose) {
                activeMenus.forEach(menu => {
                    menu.classList.remove('active');
                });
            }
        }
    }
});

// Обработка Enter в поле ввода
document.getElementById('chatInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
    }
});
</script>
{% endblock %}
